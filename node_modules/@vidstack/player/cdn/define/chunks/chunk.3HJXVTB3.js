import{a as C}from"./chunk.RH4MXEKZ.js";import{$ as H,E as g,a as E,ha as y,ia as b,ka as S,o as _,p as o,qa as L,v as n,w as c,y as u,z as v}from"./chunk.DPV5XUTO.js";var l=new Map;function V(s){return l.has(s)}async function T(s,r={}){if(n(s))return;if(r.onLoadStart?.(),!v(s))return r.onLoaded?.(s),s;let e=String(s);if(l.has(e)){let t=l.get(e);return r.onLoaded?.(t),t}try{let t=(await s())?.default;if(t&&!!t.isSupported)r.onLoaded?.(t),l.set(e,t);else throw Error("");return t}catch(t){r.onLoadError?.(t)}}async function w(s,r={}){if(!!u(s)){if(l.has(s))return l.get(s);r.onLoadStart?.();try{if(await b.load(s),!v(window.Hls))throw Error("");let e=window.Hls;return r.onLoaded?.(e),l.set(s,e),e}catch(e){r.onLoadError?.(e)}}}function f(s){return S(s.replace("vds-",""))}var D="vds-hls-",M=["lib-load","instance","unsupported"];function m(s){return s.startsWith(D)&&!M.some(r=>s.startsWith(`${D}${r}`))}var x=/\.(m3u8)($|\?)/i;var j="https://cdn.jsdelivr.net/npm/hls.js@^1.0.0/dist/hls.light",K=`${j}.js`,O=`${j}.min.js`,h=class extends C{constructor(){super();this.it=!1;this.hlsConfig={};this.hlsLibrary=O;this.K="";this._e=[];Object.defineProperty(this,"hls-config",{set:e=>{this.hlsConfig=e}}),Object.defineProperty(this,"hls-library",{set:e=>{this.hlsLibrary=e}})}get Hls(){return this.st}get hlsEngine(){return this.tt}get isHlsEngineAttached(){return this.it}get currentHlsSrc(){return this.K}async update(e){super.update(e),e.has("hlsLibrary")&&g()&&this.Sn()}destroy(){this.ci(),super.destroy()}get isHlsSupported(){return this.Hls?.isSupported()??g()}get isHlsStream(){return this.state.src.some(e=>x.test(e))}Sn(){this.canLoad||!u(this.hlsLibrary)||V(this.hlsLibrary)||y(this.hlsLibrary)}async Mn(e=!1){if(c(this.videoElement)&&!e&&!n(this.hlsEngine)){this.z?.infoGroup("\u{1F3D7}\uFE0F Could not build HLS engine").labelledLog("Video Element",this.videoElement).labelledLog("HLS Engine",this.hlsEngine).labelledLog("Force Rebuild Flag",e).dispatch();return}n(this.hlsEngine)||this.ci();let t={onLoadStart:()=>{this.dispatchEvent(o("vds-hls-lib-load-start"))},onLoaded:i=>{this.dispatchEvent(o("vds-hls-lib-loaded",{detail:i}))},onLoadError:i=>{this.dispatchEvent(o("vds-hls-lib-load-error",{detail:i})),this.dispatchEvent(o("vds-error",{detail:{message:i.message,code:4}}))}};if(this.st=await w(this.hlsLibrary,t),n(this.st)&&!u(this.hlsLibrary)&&(this.st=await T(this.hlsLibrary,t)),!!this.Hls){if(!this.Hls?.isSupported?.()){let i="[vds]: `hls.js` is not supported in this environment";this.dispatchEvent(o("vds-hls-unsupported")),this.dispatchEvent(o("vds-error",{detail:{message:i,code:4}}));return}this.tt=new this.Hls(this.hlsConfig),this.dispatchEvent(o("vds-hls-instance",{detail:this.hlsEngine})),this.xn()}}Pn(){this.isHlsEngineAttached||n(this.hlsEngine)||c(this.videoElement)||(this.hlsEngine.attachMedia(this.videoElement),this.it=!0)}Ln(){!this.isHlsEngineAttached||(this.hlsEngine?.detachMedia(),this.it=!1,this.K="")}Tn(e){c(this.hlsEngine)||!this.isHlsStream||e===this.K||(this.hlsEngine.loadSource(e),this.K=e)}Xe(){return this.state.mediaType==="live-video"?"live-video":this.isHlsStream?"video":super.Xe()}ci(){this.tt?.destroy(),this.K="",this.tt=void 0,this.it=!1}ce(e){this.K.length>0&&!e.includes(this.K)&&e.push(this.K),super.ce(e)}Ze(e){if(this.isHlsSupported){for(let t of this.state.src)if(x.test(t)){this.kn(t);return}}super.Ze(e)}async kn(e){if(this.K!==e&&!(!this.hasUpdated||!this.canLoad)){if(!this.isHlsStream){this.Ln();return}c(this.hlsLibrary)||(n(this.hlsEngine)&&await this.Mn(),this.Pn(),this.Tn(e))}}xe(e){super.xe(e),this.Vi({event:e,duration:this.mediaElement.duration})}xn(){n(this.hlsEngine)||n(this.Hls)||(this.hlsEngine.on(this.Hls.Events.LEVEL_LOADED,this.Rn.bind(this)),this._e.forEach(({type:e,listener:t,options:i})=>{this.hlsEngine?.[i?.once?"once":"on"](e,t,i?.context)}),this.hlsEngine.on(this.Hls.Events.ERROR,this._n.bind(this)))}_n(e,t){if(!n(this.Hls)&&t.fatal)switch(t.type){case"networkError":this.Vn();break;case"mediaError":this.Dn();break;default:this.qn();break}}Vn(){this.hlsEngine?.startLoad()}Dn(){this.hlsEngine?.recoverMediaError()}qn(){this.ci()}Rn(e,t){this.state.canPlay||this.An(e,t)}An(e,t){let{live:i,totalduration:d}=t.details,a=new _(e,{detail:t}),p=i?"live-video":"video";this.state.mediaType!==p&&this.dispatchEvent(o("vds-media-type-change",{detail:p,triggerEvent:a})),this.state.duration!==d&&this.dispatchEvent(o("vds-duration-change",{detail:d,triggerEvent:a}))}addEventListener(e,t,i){if(m(e)){let d=f(e);this._e.some(p=>p.type===d&&p.listener===t)||(this._e.push({type:d,listener:t,options:i}),this.hlsEngine?.[i?.once?"once":"on"](d,t,i?.context));return}return super.addEventListener(e,t,i)}removeEventListener(e,t,i){if(m(e)){let d=f(e);this._e=this._e.filter(a=>a.type===d&&a.listener===t),this.hlsEngine?.off(d,t,i?.context,i?.once);return}return super.removeEventListener(e,t,i)}};E([L({type:Object,attribute:"hls-config"})],h.prototype,"hlsConfig",2),E([L({attribute:"hls-library"})],h.prototype,"hlsLibrary",2);H("vds-hls",h);
